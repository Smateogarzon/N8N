# Escaneo de Vulnerabilidades en n8n

## üõ°Ô∏è Implementaci√≥n de Seguridad

Hemos implementado un sistema completo de escaneo de vulnerabilidades que se ejecuta tanto localmente como en el pipeline de CI/CD.

## üìÅ Archivos de Escaneo

```
N8N/
‚îú‚îÄ‚îÄ cloudbuild.yaml           # Pipeline b√°sico con Trivy
‚îú‚îÄ‚îÄ cloudbuild-secure.yaml    # Pipeline avanzado con validaciones
‚îú‚îÄ‚îÄ scan-local.sh            # Escaneo local antes del despliegue
‚îî‚îÄ‚îÄ README-vulnerability-scanning.md  # Esta documentaci√≥n
```

## üîç Herramientas Implementadas

### 1. **Trivy** (Aqua Security)

- **Prop√≥sito**: Escaneo de vulnerabilidades en im√°genes Docker
- **Cobertura**: CVE, configuraciones de seguridad, secretos
- **Severidades**: CRITICAL, HIGH, MEDIUM, LOW

### 2. **Google Artifact Analysis**

- **Prop√≥sito**: Escaneo nativo de Google Cloud
- **Cobertura**: Vulnerabilidades conocidas en paquetes
- **Integraci√≥n**: Autom√°tica con Container Registry

## üöÄ Uso Local

### Escaneo antes del despliegue

```bash
# Dar permisos al script
chmod +x scan-local.sh

# Ejecutar escaneo completo
./scan-local.sh
```

### Escaneo manual con Trivy

```bash
# Opci√≥n 1: Instalar Trivy localmente
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Opci√≥n 2: Usar Dockerfile con Trivy integrado
docker build -f Dockerfile.with-trivy -t my-n8n-image:latest .

# Escanear imagen
trivy image my-n8n-image:latest

# Escanear solo vulnerabilidades cr√≠ticas/altas
trivy image --severity HIGH,CRITICAL my-n8n-image:latest

# Escanear configuraci√≥n de seguridad
trivy config .
```

## üîÑ Pipeline de CI/CD

### Pipeline B√°sico (`cloudbuild.yaml`)

```yaml
# Escaneo con Trivy
- name: 'aquasec/trivy'
  args:
    - 'image'
    - '--severity'
    - 'HIGH,CRITICAL'
    - '--exit-code'
    - '1'
    - 'gcr.io/$PROJECT_ID/n8n:$COMMIT_SHA'

# Escaneo con Google Artifact Analysis
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args:
    - 'artifacts'
    - 'docker'
    - 'images'
    - 'scan'
    - 'gcr.io/$PROJECT_ID/n8n:$COMMIT_SHA'
```

### Pipeline Avanzado (`cloudbuild-secure.yaml`)

- ‚úÖ Escaneo de m√∫ltiples severidades
- ‚úÖ Validaci√≥n autom√°tica de resultados
- ‚úÖ Reportes detallados
- ‚úÖ Fail-fast en vulnerabilidades cr√≠ticas
- ‚úÖ Recursos optimizados para escaneos

## üìä Niveles de Severidad

### CRITICAL

- **Acci√≥n**: Bloquea el despliegue
- **Ejemplos**: RCE, escalaci√≥n de privilegios
- **Pol√≠tica**: Corregir inmediatamente

### HIGH

- **Acci√≥n**: Bloquea el despliegue
- **Ejemplos**: DoS, acceso no autorizado
- **Pol√≠tica**: Corregir antes del despliegue

### MEDIUM

- **Acci√≥n**: Reporte informativo
- **Ejemplos**: Informaci√≥n de debug, logs
- **Pol√≠tica**: Revisar y corregir cuando sea posible

### LOW

- **Acci√≥n**: Reporte informativo
- **Ejemplos**: Configuraciones no √≥ptimas
- **Pol√≠tica**: Mejorar en futuras versiones

## üîß Configuraci√≥n

### Habilitar APIs necesarias

```bash
# Google Artifact Analysis
gcloud services enable artifactregistry.googleapis.com
gcloud services enable containerscanning.googleapis.com

# Cloud Build
gcloud services enable cloudbuild.googleapis.com
```

### Configurar pol√≠ticas de escaneo

```bash
# Configurar pol√≠tica de escaneo autom√°tico
gcloud artifacts repositories create n8n-repo \
    --repository-format=docker \
    --location=us \
    --description="n8n container repository"

# Habilitar escaneo autom√°tico
gcloud artifacts docker images scan-enable \
    --repository=n8n-repo \
    --location=us
```

## üìà Monitoreo y Alertas

### Configurar alertas de seguridad

```bash
# Crear canal de notificaciones
gcloud logging sinks create security-alerts \
    storage.googleapis.com/projects/$PROJECT_ID/buckets/security-logs \
    --log-filter='resource.type="cloud_run_revision" AND severity>=ERROR'

# Configurar alertas para vulnerabilidades
gcloud monitoring policies create \
    --policy-from-file=vulnerability-alert-policy.yaml
```

### Verificar resultados de escaneo

```bash
# Ver escaneos recientes
gcloud artifacts docker images list-vulnerabilities \
    gcr.io/$PROJECT_ID/n8n:latest \
    --location=us

# Ver detalles de vulnerabilidades
gcloud artifacts docker images describe \
    gcr.io/$PROJECT_ID/n8n:latest \
    --location=us
```

## üö® Respuesta a Incidentes

### Cuando se encuentran vulnerabilidades cr√≠ticas

1. **Detener el pipeline**

   ```bash
   # El build fallar√° autom√°ticamente
   # Revisar logs en Cloud Build
   ```

2. **Analizar vulnerabilidades**

   ```bash
   # Ver detalles
   cat scan-results/security-report.txt

   # Verificar CVE espec√≠ficos
   trivy image --severity HIGH,CRITICAL my-n8n-image:latest
   ```

3. **Corregir vulnerabilidades**

   ```dockerfile
   # Actualizar imagen base
   FROM n8nio/n8n:latest

   # Actualizar paquetes
   RUN apk update && apk upgrade
   ```

4. **Re-ejecutar escaneos**

   ```bash
   # Escaneo local
   ./scan-local.sh

   # Re-ejecutar pipeline
   gcloud builds submit --config=cloudbuild-secure.yaml
   ```

## üìã Checklist de Seguridad

### Antes del despliegue

- [ ] Ejecutar `./scan-local.sh`
- [ ] Revisar reporte de vulnerabilidades
- [ ] Corregir vulnerabilidades cr√≠ticas/altas
- [ ] Verificar configuraci√≥n de seguridad

### Durante el despliegue

- [ ] Pipeline ejecuta escaneos autom√°ticamente
- [ ] Validar que no hay vulnerabilidades cr√≠ticas
- [ ] Revisar logs de Cloud Build
- [ ] Confirmar despliegue exitoso

### Mantenimiento

- [ ] Ejecutar escaneos semanalmente
- [ ] Actualizar imagen base regularmente
- [ ] Revisar nuevas vulnerabilidades
- [ ] Actualizar pol√≠ticas de seguridad

## üîó Recursos Adicionales

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Google Artifact Analysis](https://cloud.google.com/artifact-registry/docs/analysis)
- [Container Security Best Practices](https://cloud.google.com/architecture/container-security)
- [CVE Database](https://cve.mitre.org/)

## üí° Mejores Pr√°cticas

1. **Escaneo temprano**: Ejecutar escaneos antes del merge
2. **Automatizaci√≥n**: Integrar en CI/CD pipeline
3. **Monitoreo continuo**: Escaneos regulares en producci√≥n
4. **Respuesta r√°pida**: Corregir vulnerabilidades cr√≠ticas inmediatamente
5. **Documentaci√≥n**: Mantener registro de vulnerabilidades y correcciones
